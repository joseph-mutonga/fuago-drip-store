<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Dashboard</title>
  <style>
    :root {
      --accent: #ffa41c;
      --bg: #f8f9fb;
      --card: #fff;
      --text: #1f2937;
      --muted: #6b7280;
      --shadow: 0 3px 10px rgba(0,0,0,0.08);
      --radius: 10px;
    }
    body { margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); color: var(--text); }

    /* header */
    header {
      background: #232f3e;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 { font-size: 20px; margin: 0; }
    .header-btns { display:flex; align-items:center; gap:12px; }

    .btn {
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #000;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 600;
      position: relative;
    }

    .profile-icon {
      background: #fff;
      color: #232f3e;
      font-size: 18px;
      border-radius: 50%;
      width: 36px; height: 36px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }

    /* cart badge */
    .cart-wrap { position: relative; }
    .cart-badge {
      position: absolute;
      top: -6px;
      right: -8px;
      background: #e63946;
      color:#fff;
      width:18px; height:18px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:12px; font-weight:700;
    }

    /* layout */
    main { padding: 20px; transition: filter .3s ease; }
    #searchContainer { margin-bottom: 20px; }
    #searchInput {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      outline: none;
      box-sizing: border-box;
    }
    .product-grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
      gap:18px;
    }
    .product-card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
      text-align:center;
      transition: transform .12s ease;
    }
    .product-card:hover { transform: translateY(-6px); }
    .product-card img { width:100%; height:160px; object-fit:cover; border-radius:8px; }
    .product-card h3 { margin:8px 0 6px; font-size:16px; }
    .price { color:var(--accent); font-weight:700; }
    .cart-btn {
      margin-top:10px;
      padding:8px 10px;
      border-radius:8px;
      border:none;
      font-weight:700;
      cursor:pointer;
    }
    .cart-btn.add { background:var(--accent); color:#000; }
    .cart-btn.remove { background:#e63946; color:#fff; }
    .small-muted { color:var(--muted); font-size:13px; }

    /* Sidebar overlay */
    #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display:none; z-index: 50; transition: opacity 0.3s ease; }
    #accountSidebar { position: fixed; top:0; right:0; width:25%; max-width:300px; height:100%; background:#fff; box-shadow: -2px 0 8px rgba(0,0,0,0.2); padding:20px; transform: translateX(100%); transition: transform 0.3s ease; z-index: 51; overflow-y: auto; }
    #accountSidebar.active { transform: translateX(0); }
    #overlay.active { display: block; }
    main.sidebar-open { filter: blur(2px); pointer-events: none; }

    /* Footer */
    footer { background:#232f3e; color:#fff; padding:20px; text-align:center; }
    footer a { color:#fff; margin:0 8px; text-decoration:none; }
    footer a:hover { text-decoration:underline; }

    /* Responsive */
    @media screen and (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; overflow-x: auto; }
      .main { padding: 10px; }
      .product-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    }
    @media screen and (max-width: 480px) {
      .sidebar button { font-size: 14px; padding: 8px; }
      .product-card img { height: 120px; }
      form input, form textarea, form button { padding: 8px; font-size: 14px; }
    }

    /* Order tracking */
    #orderTracking { background: #fff3e0; border-radius: 10px; padding: 12px; margin: 12px 0; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    #orderCountdown { font-weight: 700; color: #e65100; }

    /* Account details */
    #accountDetails { margin-bottom: 12px; background: #e8f0fe; padding: 12px; border-radius: 10px; text-align: center; }
    #accountDetails img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 8px; object-fit: cover; }
  </style>
</head>
<body>
<header>
  <h1 style="background-color: white; color: black;">üõçÔ∏è My Store</h1>
  <div class="header-btns">
    <div class="cart-wrap">
      <button class="btn" id="viewCartBtn" onclick="goToCart()">üõí Cart</button>
      <div id="cartBadge" class="cart-badge" style="display:none">0</div>
    </div>
    <div class="profile-icon" onclick="openSidebar()">üë§</div>
  </div>
</header>

<!-- Sidebar -->
<div id="overlay" onclick="closeSidebar()"></div>
<div id="accountSidebar">
  <h2>üë§ Account</h2>
  <div id="accountDetails">
    <img id="userPhoto" src="" alt="User Photo" />
    <p id="userName">Hello, User</p>
    <p id="userEmail">Email: user@example.com</p>
    <div id="extraUserDetails"></div>
  </div>

  <div id="orderTracking">
    <h3>üöö Order Delivery Countdown</h3>
    <p id="orderCountdown">Loading...</p>
  </div>

  <button class="btn" onclick="logout()">Logout</button>
</div>

<main id="mainContent">
  <!-- Search Bar -->
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search for a product..." />
  </div>

  <div id="product-container" class="product-grid"></div>
</main>

<footer id="companyFooter">
  <h3>About Our Company</h3>
  <p id="companyDescription">We are a trusted store providing quality products to our customers. Contact us anytime!</p>
  <div id="socialLinks">
    <a href="https://facebook.com/YourCompany" target="_blank">Facebook</a>
    <a href="https://twitter.com/YourCompany" target="_blank">Twitter</a>
    <a href="https://instagram.com/YourCompany" target="_blank">Instagram</a>
    <a href="mailto:contact@yourcompany.com">Email</a>
  </div>
</footer>

<script>
let cartMap = {};
let userCartSet = new Set();
let allProducts = [];
const token = localStorage.getItem("token");

function tryParseJSON(s){ try { return JSON.parse(s); } catch { return null; } }

async function fetchUserCart() {
  if (!token) { cartMap = {}; userCartSet = new Set(); updateCartBadge(0); return; }
  const res = await fetch("/user/cart", { headers: { "Authorization": `Bearer ${token}` } });
  if (!res.ok) { cartMap = {}; userCartSet = new Set(); updateCartBadge(0); return; }
  const items = await res.json();
  cartMap = {}; userCartSet = new Set();
  items.forEach(item => {
    const pid = item.product_id ?? item.productId;
    if (pid != null) { cartMap[pid] = item.id; userCartSet.add(pid); } 
    else if (item.name && item.price != null) { const key = `${item.name}||${item.price}`; cartMap[key] = item.id; userCartSet.add(key); }
  });
  updateCartBadge(items.length);
  return items;
}

function updateCartBadge(count) {
  const badge = document.getElementById("cartBadge");
  if (!count || count===0) badge.style.display="none";
  else { badge.style.display="flex"; badge.textContent=count; }
}

function updateCartBadgeFromStorage() { const count = parseInt(localStorage.getItem("cartCount") || "0"); updateCartBadge(count); }
window.addEventListener("storage", () => { updateCartBadgeFromStorage(); });

(async function init(){
  updateCartBadgeFromStorage();
  await loadProducts();
  fetchUserDetails();
  startOrderTracking();
})();

// Render products helper
function renderProducts(products) {
  const container = document.getElementById("product-container");
  container.innerHTML = "";
  if (!products || products.length===0) { container.innerHTML = "<p class='small-muted'>No products found.</p>"; return; }
  products.forEach(p => {
    const pid = p.id;
    const inCart = userCartSet.has(pid) || userCartSet.has(`${p.name}||${p.price}`);
    const btn = document.createElement("button");
    btn.className = "cart-btn " + (inCart?"remove":"add");
    if (p.quantity<=0) { btn.disabled=true; btn.textContent="Out of Stock"; btn.style.background="#ccc"; btn.style.cursor="not-allowed"; }
    else { btn.textContent = inCart ? "Remove from Cart" : "Add to Cart"; btn.onclick = () => toggleCart(pid,p,btn); }
    const card = document.createElement("div");
    card.className="product-card";
    card.innerHTML=`
      <img src="${p.image||''}" alt="${p.name}">
      <h3>${p.name}</h3>
      <div class="price">Ksh ${p.price}</div>
      <div class="small-muted" style="height:18px;">Available: ${p.quantity}</div>
      <div class="small-muted" style="height:36px; overflow:hidden;">${(p.description||'').slice(0,120)}</div>
    `;
    card.appendChild(btn);
    container.appendChild(card);
  });
}

async function loadProducts() {
  await fetchUserCart();
  const res = await fetch("/products");
  if (!res.ok) { document.getElementById("product-container").innerHTML = "<p class='small-muted'>Failed to load products.</p>"; return; }
  allProducts = await res.json();
  renderProducts(allProducts);
}

// Search functionality
document.getElementById("searchInput").addEventListener("input", (e)=>{
  const query = e.target.value.trim().toLowerCase();
  const filtered = allProducts.filter(p => p.name.toLowerCase().includes(query));
  renderProducts(filtered);
});

async function toggleCart(productId, productObj, btnElement) {
  if (!token) { window.location.href="login.html"; return; }
  const inCart = userCartSet.has(productId) || userCartSet.has(`${productObj.name}||${productObj.price}`);
  if (!inCart) {
    const res = await fetch("/user/cart/add",{method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`}, body: JSON.stringify({product_id: productId})});
    if(res.ok){ await fetchUserCart(); btnElement.classList.remove("add"); btnElement.classList.add("remove"); btnElement.textContent="Remove from Cart"; }
  } else {
    let cartRowId = cartMap[productId] || cartMap[`${productObj.name}||${productObj.price}`];
    if(!cartRowId){
      const items = await fetchUserCart();
      for(const it of items||[]){ if((it.product_id && it.product_id===productId)||(it.name===productObj.name && Number(it.price)===Number(productObj.price))){ cartRowId=it.id; break; } }
    }
    if(!cartRowId){ console.error("Could not find cart row id to remove"); await fetchUserCart(); await renderProducts(allProducts); return; }
    const delRes = await fetch(`/user/cart/${cartRowId}`,{method:"DELETE", headers:{"Authorization":`Bearer ${token}`}}); 
    if(delRes.ok){
      for(const key of Object.keys(cartMap)){ if(String(cartMap[key])===String(cartRowId)){ delete cartMap[key]; if(key.includes("||")) userCartSet.delete(key); else userCartSet.delete(Number(key)); } }
      userCartSet.delete(productId);
      btnElement.classList.remove("remove"); btnElement.classList.add("add"); btnElement.textContent="Add to Cart";
      const latestItems = await fetchUserCart();
      updateCartBadge((latestItems && latestItems.length)||0);
    }
  }
  await fetchUserCart();
}

function goToCart(){ window.location.href="cart.html"; }
function openSidebar(){ document.getElementById("accountSidebar").classList.add("active"); document.getElementById("overlay").classList.add("active"); document.querySelector("main").classList.add("sidebar-open"); }
function closeSidebar(){ document.getElementById("accountSidebar").classList.remove("active"); document.getElementById("overlay").classList.remove("active"); document.querySelector("main").classList.remove("sidebar-open"); }
function logout(){ localStorage.removeItem("token"); window.location.href="login.html"; }

async function fetchUserDetails() {
  if (!token) return;
  try {
    const res = await fetch("/auth/me", { headers: { "Authorization": `Bearer ${token}` } });
    if (!res.ok) return;
    const user = await res.json();
    if (!user) return;
    document.getElementById("userName").textContent = user.name || "Hello, User";
    document.getElementById("userEmail").textContent = "Email: "+(user.email||"N/A");
    document.getElementById("userPhoto").src = user.photo || "https://via.placeholder.com/80";
    const extra = document.getElementById("extraUserDetails");
    extra.innerHTML = "";
    for (const key in user) { if(["name","email","photo"].includes(key)) continue; extra.innerHTML += `<p>${key}: ${user[key]}</p>`; }
  } catch(e){ console.error("Error fetching user details", e); }
}

async function startOrderTracking() {
  if (!token) { document.getElementById("orderCountdown").textContent="Login to track orders"; return; }
  try {
    const res = await fetch("/user/orders",{ headers: { "Authorization": `Bearer ${token}` } });
    if(!res.ok){ document.getElementById("orderCountdown").textContent="No orders found"; return; }
    const orders = await res.json();
    if(!orders||orders.length===0){ document.getElementById("orderCountdown").textContent="No orders found"; return; }
    const latestOrder = orders[0];
    const createdAt = new Date(latestOrder.created_at);
    const deliveryTime = new Date(createdAt.getTime()+2*24*60*60*1000);
    function updateCountdown(){
      const now = new Date();
      let diff = deliveryTime-now;
      if(diff<=0){ document.getElementById("orderCountdown").textContent="‚úÖ Delivered"; clearInterval(timer); return; }
      const days=Math.floor(diff/(1000*60*60*24));
      diff-=days*24*60*60*1000;
      const hours=Math.floor(diff/(1000*60*60));
      diff-=hours*60*60*1000;
      const minutes=Math.floor(diff/(1000*60));
      diff-=minutes*60*1000;
      const seconds=Math.floor(diff/1000);
      document.getElementById("orderCountdown").textContent=`${days}d ${hours}h ${minutes}m ${seconds}s remaining`;
    }
    updateCountdown();
    const timer=setInterval(updateCountdown,1000);
  } catch(e){ document.getElementById("orderCountdown").textContent="Error loading orders"; console.error(e); }
}
</script>
</body>
</html>
